Scene.prototype.sm_save=function(e){var t=this.tokenizeExpr(e);if(t.length>2)throw new Error("sm_save: Invalid number of arguments, expected 0, 1 (save name) or 2 (id).");ChoiceScriptSavePlugin._save((new Date).getTime(),t.length==1?this.evaluateExpr(t):null)};Scene.prototype.sm_load=function(e){var t=this.tokenizeExpr(e);var i=this.evaluateExpr(t);this.finished=true;this.skipFooter=true;this.screenEmpty=true;ChoiceScriptSavePlugin._load(i)};Scene.prototype.sm_delete=function(e){var t=this.tokenizeExpr(e);if(t.length!=1)throw new Error("sm_delete: Invalid number of arguments, expected 1.");ChoiceScriptSavePlugin._delete(this.evaluateExpr(t))};Scene.prototype.sm_update=function(){if(typeof this.stats._sm_save_count==="undefined")this.stats._sm_save_count=0;ChoiceScriptSavePlugin._getSaveList(function(e){if(!e)return;ChoiceScriptSavePlugin._syncHelperVariables(e,function(){})})};Scene.prototype.sm_menu=function(e){e=e||"";e=e.toLowerCase();var t=document.getElementById("quickSaveMenu");if(!t)return;var i=false;if(e==="false"){i=false}else if(e==="true"){i=true}else if(!e){i=t.style.display=="none"}else{throw new Error("*sm_menu: expected true, false (or nothing) as an argument!")}t.style.display=i?"inline":"none";var n=document.getElementsByClassName("savePluginBtn");for(var a=0;a<n.length;a++){n[a].style.display=i?"inline":"none"}};Scene.validCommands["sm_save"]=1;Scene.validCommands["sm_load"]=1;Scene.validCommands["sm_delete"]=1;Scene.validCommands["sm_update"]=1;Scene.validCommands["sm_menu"]=1;var ChoiceScriptSavePlugin={};ChoiceScriptSavePlugin._CSS="#quickSaveMenu {        margin: 5px;        width: 100px;    }";ChoiceScriptSavePlugin._save=function(i,e){restoreObject(initStore(),"state",null,function(t){if(t){t.stats["_smSaveName"]=e||"";t.stats["_smSaveDateId"]=i;ChoiceScriptSavePlugin._addToSaveList(i,function(e){if(!e)return;saveCookie(function(){},ChoiceScriptSavePlugin._formatSlotName(i),t.stats,t.temps,t.lineNum,t.indent,this.debugMode,this.nav);setTimeout(function(){var e=document.getElementById("quickSaveMenu");if(e){e.innerHTML="";ChoiceScriptSavePlugin._populateSaveMenu(e)}},3e3)})}else{}})};ChoiceScriptSavePlugin._formatSlotName=function(e){return window.storeName+"_SAVE_"+e};ChoiceScriptSavePlugin._load=function(e){clearScreen(loadAndRestoreGame.bind(stats.scene,ChoiceScriptSavePlugin._formatSlotName(e)))};ChoiceScriptSavePlugin._delete=function(n){ChoiceScriptSavePlugin._removeFromSaveList(n,function(e){if(!e)return;var t=document.getElementById("quickSaveMenu");if(t){var i=t.options[t.selectedIndex];if(i)i.parentElement.removeChild(i)}initStore().remove("state"+ChoiceScriptSavePlugin._formatSlotName(n),function(e,t){})})};ChoiceScriptSavePlugin._createQuickSaveMenu=function(){var e=document.getElementById("restartButton").parentElement;if(!e){alert("Error: unable to attach quick save menu");return}var t=document.getElementsByTagName("head")[0];var i=document.createElement("style");i.innerHTML=ChoiceScriptSavePlugin._CSS;t.appendChild(i);var n=document.createElement("select");n.setAttribute("id","quickSaveMenu");e.appendChild(n);var a=[{innerHTML:"New Save",clickFunc:"ChoiceScriptSavePlugin.save();"},{innerHTML:"Load",clickFunc:"ChoiceScriptSavePlugin.load();"},{innerHTML:"Delete",clickFunc:"ChoiceScriptSavePlugin.delete();"}];for(var o=0;o<a.length;o++){var r=document.createElement("button");r.innerHTML=a[o].innerHTML;r.setAttribute("class","spacedLink savePluginBtn");r.setAttribute("onclick",a[o].clickFunc);e.appendChild(r)}return n};ChoiceScriptSavePlugin._populateSaveMenu=function(n){ChoiceScriptSavePlugin._getSaveList(function(e){if(!e)return;e.forEach(function(e){ChoiceScriptSavePlugin._getSaveData(e,function(e){if(!e){return}var t=document.createElement("option");t.setAttribute("value",e.stats._smSaveDateId);if(!e){t.innerHTML="Failed to load save."}else{var i=e.stats.sceneName+".txt ("+simpleDateTimeFormat(new Date(parseInt(e.stats._smSaveDateId)))+")";if(e.stats._smSaveName){i=e.stats._smSaveName+" &mdash; "+i}t.innerHTML=i}n.appendChild(t)})})})};ChoiceScriptSavePlugin._getSaveData=function(e,t){restoreObject(initStore(),"state"+ChoiceScriptSavePlugin._formatSlotName(e),null,function(e){if(e){t(e)}else{t(null)}})};ChoiceScriptSavePlugin._removeFromSaveList=function(t,n){ChoiceScriptSavePlugin._getSaveList(function(i){if(!i)return;var e=i.indexOf(t.toString());if(e>-1)i.splice(e,1);initStore().set("save_list",i.join(" "),function(e,t){ChoiceScriptSavePlugin._syncHelperVariables(i,function(){n(e)})})})};ChoiceScriptSavePlugin._addToSaveList=function(e,n){ChoiceScriptSavePlugin._getSaveList(function(i){if(!i)return;i.push(e.toString());initStore().set("save_list",i.join(" "),function(e,t){ChoiceScriptSavePlugin._syncHelperVariables(i,function(){n(e)})})})};ChoiceScriptSavePlugin._syncHelperVariables=function(e,t){self.stats._sm_save_count=e.length;e.forEach(function(t,i){ChoiceScriptSavePlugin._getSaveData(t,function(e){if(e){self.stats["_sm_save_id_"+i]=t;self.stats["_sm_save_name_"+i]=e.stats._smSaveName||"";self.stats["_sm_save_date_"+i]=simpleDateTimeFormat(new Date(parseInt(t)))}})});t()};ChoiceScriptSavePlugin._getSaveList=function(i){initStore().get("save_list",function(e,t){if(!e)i(null);if(!t)i([]);else i(saveList=t.split(" ").sort(function(e,t){return t-e}))})};ChoiceScriptSavePlugin._init=function(){if("file:"===window.location.protocol&&(typeof window.uploadedFiles==="undefined"&&typeof allScenes==="undefined")){setTimeout(ChoiceScriptSavePlugin._init,3e3);return}if(!window.storeName){Scene.validCommands["sm_save"]=0;Scene.validCommands["sm_load"]=0;Scene.validCommands["sm_delete"]=0;Scene.validCommands["sm_menu"]=0;Scene.validCommands["sm_menu"]=0;return alertify.error("Disabling ChoiceScript Save Plugin as there is no storeName detected. Please check your index.html.")}ChoiceScriptSavePlugin._populateSaveMenu(ChoiceScriptSavePlugin._createQuickSaveMenu())};ChoiceScriptSavePlugin.save=function(){if(stats.sceneName=="choicescript_stats"){alert("Error: Unable to save at this point.");return}var i=new Date;var e="What would you like to call this save?<br>Leaving this blank will result in a scene and date identifier.";alertify.prompt(e,function(e,t){if(e){ChoiceScriptSavePlugin._save(i.getTime(),t)}else{}},"Quick Save")};ChoiceScriptSavePlugin.delete=function(){var t=document.getElementById("quickSaveMenu");if(t.value<=0)return;var e="Delete save '"+t.options[t.selectedIndex].text+"'?<br>This cannot be undone!";alertify.confirm(e,function(e){if(!e){return}else{ChoiceScriptSavePlugin._delete(parseInt(t.value))}})};ChoiceScriptSavePlugin.load=function(){var t=document.getElementById("quickSaveMenu");if(t.value<=0)return;alertify.confirm("Are you sure you wish to load this save?<br>Current progress will be lost!",function(e){if(!e){return}else{ChoiceScriptSavePlugin._load(t.value)}})};setTimeout(ChoiceScriptSavePlugin._init,3e3);